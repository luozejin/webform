<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>土地利用变化检测</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
          integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <link href="libs/dist/openlayers/4.6.5/ol.css" rel="stylesheet"/>
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css"/>
    <link rel="stylesheet" href="css/form1.css"/>
    <link rel="stylesheet" href="css/mapul.css"/>
    <script type="text/javascript" src="libs/dist/openlayers/4.6.5/ol.js"></script>
    <script type="text/javascript" src="libs/dist/openlayers/iclient-openlayers.min.js"></script>
    <script type="text/javascript" src="./json_parse.js"></script>
    <script type="text/javascript" src="./toJSON.js"></script>
    <script type="text/javascript" src="./colorramps.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
</head>

<body style="background: #1E1E1E">
<div id="main">
    <div class="mapTop">
        <img src="img/logo.png"/>
        <span class="topTitle">土地利用变化检测</span>
    </div>
    <div id="map" style="width: 100%;height:100%"></div>
    <div id="popup" class="ol-popup">
        <div id="popup-content"></div>
    </div>
    <button id="Fbtn" class="btn btn-outline-dark">土地利用变化检测</button>

    <!-- 模型表单 -->
    <form id="boxs" name="form">
        <div class="Ftop">
            <span id="Ferr">×</span>
        </div>
        <div class="Fmid">
            <div class="Fmid-1">
                <span class="Fmid-1-one">一调地类图斑数据路径<span class="defaltvalue">*</span></span>
                <input type="text" name="20ef9b62-03f6-43b2-904c-141f8d648aa4">
            </div>

            <div class="Fmid-1">
                <span class="Fmid-1-one">二调地类图斑数据路径<span class="defaltvalue">*</span></span>
                <input type="text" name="f2fccedf-7f51-4641-9a57-9aa4cd5e7058">
            </div>

            <div class="Fmid-1">
                <span class="Fmid-1-one">叠加分析运算类型<span class="defaltvalue">*</span></span>
                <select name="operator" id="" class="Mselect">
                    <option value="Union">Union</option>
                    <option value="Clip">Clip</option>
                    <option value="intersect">intersect</option>
                    <option value="Erase">Erase</option>
                    <option value="Update">Update</option>
                    <option value="XOR">XOR</option>
                </select>
            </div>
            <div class="Fmid-1">
                <span class="Fmid-1-one">叠加数据集中保留的字段</span>
                <input type="text" name="sourceFields" value="TBMJ,DLMC" onfocus="if (value =='TBMJ,DLMC'){value =''}"
                       onblur="if (value ==''){value='TBMJ,DLMC'}">
            </div>

            <div class="Fmid-1">
                <span class="Fmid-1-one">容差</span>
                <input type="text" name="tolerance" value="0.0" onfocus="if (value =='0.0'){value =''}"
                       onblur="if (value ==''){value='0.0'}">
            </div>

            <div class="Fmid-1">
                <span class="Fmid-1-one">面积计算字段</span>
                <input type="text" name="fieldName" value="Area" onfocus="if (value =='Area'){value =''}"
                       onblur="if (value ==''){value='Area'}">
            </div>
            <div class="Fmid-1">
                <span class="Fmid-1-one">变化检测计算表达式<span class="defaltvalue">*</span></span>
                <input type="text" name="expression" value="abs(TNMJ-TBMJ_1)/BTMJ"
                    onfocus="if (value =='abs(TNMJ-TBMJ_1)/BTMJ'){value =''}"
                    onblur="if (value ==''){value='abs(TNMJ-TBMJ_1)/BTMJ'}">
            </div>
            <div class="Fmid-1">
                <span class="Fmid-1-one">变化检测结果字段<span class="defaltvalue">*</span></span>
                <input type="text" name="变化检测结果字段" value="difference"
                    onfocus="if (value =='difference'){value =''}" onblur="if (value ==''){value='difference'}">
            </div>
            <div class="Fmid-1">
                <span class="Fmid-1-one">属性统计表达式</span>
                <input type="text" name="stats" value="Area,Sum,Area"
                       onfocus="if (value =='Area,Sum,Area'){value =''}"
                       onblur="if (value ==''){value='Area,Sum,Area'}">
            </div>
            <div class="Fmid-1">
                <span class="Fmid-1-one">属性统计分组字段</span>
                <input type="text" name="groupFields" value="DLMC,DLMC_1"
                       onfocus="if (value =='DLMC,DLMC_1'){value =''}" onblur="if (value ==''){value='DLMC,DLMC_1'}">
            </div>
            <div class="Fmid-1">
                <span class="Fmid-1-one">叠加结果保存路径<span class="defaltvalue">*</span></span>
                <input type="text" name="saveas">
            </div>
            <div class="Fmid-1">
                <span class="Fmid-1-one">叠加结果数据集名<span class="defaltvalue">*</span></span>
                <input type="text" name="outputDatasetName" value="DLTB_Union"
                    onfocus="if (value =='DLTB_Union'){value =''}" onblur="if (value ==''){value='DLTB_Union'}">
            </div>

        </div>
        <input type="button" name="button" value="提交" id="Fbit" class="btn btn-outline-info">
    </form>

    <!-- 属性表 -->
    <div class="attributeTable">
        <table id="table">

            <!-- 分页  -->
            <!-- <ul>
                <li class="next"></li>
                <li class="prev"></li>
                <li class="total"></li>
                <li class="cur_page"></li>
            </ul> -->
       </table>
    </div>
    

</div>
<script>
    var Box = document.getElementById('boxs');
    var Btn = document.getElementById('Fbtn');
    var Err = document.getElementById('Ferr');

    Btn.onclick = function () {
        Box.style.display = "block";
    }

    Err.onclick = function () {
        Box.style.display = "none";
    }
</script>

<script type="text/javascript" src="js/jquery.min.js"></script>
<script src="js/page.js"></script>


<script type="text/javascript">
    var Adata = {
        "processes": {
            "f2fccedf-7f51-4641-9a57-9aa4cd5e7058": {
                "readasfeaturerdd": {
                    "dataConnInfo":"sdx --server=E:\\\\Jin\\\\work\\\\2020.03.05\\\\ChangeDetection_sample1\\\\Landuse.udbx --dbType=UDBX --dataset=DLTB_ed"
                }
            },
            "20ef9b62-03f6-43b2-904c-141f8d648aa4": {
                "readasfeaturerdd": {
                    "dataConnInfo":"sdx --server=E:\\\\Jin\\\\work\\\\2020.03.05\\\\ChangeDetection_sample1\\\\Landuse.udbx --dbType=UDBX --dataset=DLTB"
                }
            },
            "92693d20-db9d-42cc-8747-369db3605464": {
                "overlayanalyst": {
                    "sourceFields": [
                        "TBMJ",
                        "DLMC"
                    ],
                "overlayFields": [
                    "TBMJ",
                    "DLMC"
                ],
                "operator":"Intersect",
                "tolerance":"0.0",
                "isIniProcess":"true",
                "isReturnSingleGeometry":"true"
                }
            },
            "0d786a6a-59a1-42b9-b507-67f5500dfcc7": {
                "calculatearea": {
                    "fieldName":"Area",
                    "isPreciseArea":"false"
                }
            },
            "1a58d3cd-ac14-453f-8302-7f65f1eb1c5e": {
                "calculatefield": { 
                    "fieldName":"rate",
                    "fieldType":"double",
                    "expression":"abs(TBMJ - TBMJ_1) / TBMJ"
                }
            },
            "36a48921-4298-409f-81df-c83c9c7ce98e": {
                "summarizeattributes": {
                    "stats": [
                        "Area,Sum,Area"
                    ],
                    "groupFields": [
                        "DLMC",
                        "DLMC_1"
                    ]
                }
            },
            "8d0a7851-8fa7-42f0-beda-6af47c36c207": {
                "saveas": {
                    "dataConnInfo":"sdx --server=E:\\\\Jin\\\\work\\\\2020.03.05\\\\ChangeDetection_sample1\\\\Landuse.udbx --dbType=UDBX --dataset=DLTB_ed"
                }
            },
            "63f307ac-afed-4720-bbfd-423ac68a0ff9": {
                "publishmap": {
                    "server":"http://localhost:8090",
                    "user":"luozejin",
                    "password":"a.201997",
                    "isEditable":"false"
                }
            },
            "b75c4152_cc303": {
                "printfeaturerddtojson": {
                    "num":"-1"
                }
            }
        },
        "connect": [
            {
                "from":"1a58d3cd-ac14-453f-8302-7f65f1eb1c5e|featureRDD",
                "to":"8d0a7851-8fa7-42f0-beda-6af47c36c207|featureRdd"
            },
            {
                "from":"8d0a7851-8fa7-42f0-beda-6af47c36c207|isSuccessful",
                "to":"63f307ac-afed-4720-bbfd-423ac68a0ff9|dataConnection"
            },
            {
                "from":"f2fccedf-7f51-4641-9a57-9aa4cd5e7058|featureRDD",
                "to":"92693d20-db9d-42cc-8747-369db3605464|overlayRDD"
            },
            {
                "from":"0d786a6a-59a1-42b9-b507-67f5500dfcc7|featureRDD",
                "to":"36a48921-4298-409f-81df-c83c9c7ce98e|summarizedRDD"
            },
            {
                "from":"0d786a6a-59a1-42b9-b507-67f5500dfcc7|featureRDD",
                "to":"1a58d3cd-ac14-453f-8302-7f65f1eb1c5e|featureRDD"
            },
            {
                "from":"20ef9b62-03f6-43b2-904c-141f8d648aa4|featureRDD",
                "to":"92693d20-db9d-42cc-8747-369db3605464|sourceRDD"
            },
            {
                "from":"92693d20-db9d-42cc-8747-369db3605464|featureRDD",
                "to":"0d786a6a-59a1-42b9-b507-67f5500dfcc7|featureRDD"
            },
            {
                "from":"36a48921-4298-409f-81df-c83c9c7ce98e|featureRDD",
                "to":"b75c4152_cc303|featureRDD"
            }
        ],
        "env": {
            "master":"",
            "appName":"",
            "settings":""
        },
        "ui":{}
    };

   

    $('#Fbit').click(function () {
        var formData = $('#boxs').serializeArray();
        var jsonObj = {};
        for (var i in formData) {
            jsonObj[formData[i].name] = formData[i].value;
        }
        // console.log(jsonObj); // object 表单json
        // console.log(data); // string
        Adata["processes"]["20ef9b62-03f6-43b2-904c-141f8d648aa4"]["readasfeaturerdd"]["dataConnInfo"] = jsonObj["20ef9b62-03f6-43b2-904c-141f8d648aa4"]; // 一调地类图斑数据路径
        Adata["processes"]["f2fccedf-7f51-4641-9a57-9aa4cd5e7058"]["readasfeaturerdd"]["dataConnInfo"] = jsonObj["f2fccedf-7f51-4641-9a57-9aa4cd5e7058"];  // 二调地类图斑数据路径

        Adata["processes"]["92693d20-db9d-42cc-8747-369db3605464"]["overlayanalyst"]
        ["operator"] = jsonObj["operator"]; // 叠加分析运算类型

        Adata["processes"]["92693d20-db9d-42cc-8747-369db3605464"]["overlayanalyst"]["sourceFields"] = jsonObj["sourceFields"].split(",");  // 叠加数据集中保留的字段
        Adata["processes"]["92693d20-db9d-42cc-8747-369db3605464"]["overlayanalyst"]["tolerance"] = jsonObj["tolerance"]; // 容差
        Adata["processes"]["0d786a6a-59a1-42b9-b507-67f5500dfcc7"]["calculatearea"]["fieldName"] = jsonObj["fieldName"]; // 面积计算字段
        Adata["processes"]["1a58d3cd-ac14-453f-8302-7f65f1eb1c5e"]["calculatefield"]["expression"] = jsonObj["expression"]; // 变化检测计算表达式
        Adata["processes"]["36a48921-4298-409f-81df-c83c9c7ce98e"]["summarizeattributes"]["stats"] = jsonObj["stats"].split(";");  // 属性统计表达式
        Adata["processes"]["36a48921-4298-409f-81df-c83c9c7ce98e"]["summarizeattributes"]["groupFields"] = jsonObj["groupFields"].split(",");  // 属性统计分组字段

        Adata["processes"]["8d0a7851-8fa7-42f0-beda-6af47c36c207"]["saveas"]["dataConnInfo"] = jsonObj["saveas"];  // 叠加结果保存路径

        // Adata["processes"]["b22a2f56_523b7"]["outputDatasetName"]= jsonObj["outputDatasetName"]; // 叠加结果数据集名

        var dataJson = JSON.stringify(Adata);
        // console.log(dataJson);
        // console.log(typeof(dataJson));
        onSubmit(dataJson)
    });
    function onSubmit(dataJson) {
        $.ajax({
            type: 'POST',
            url: 'http://localhost:8097/geoprocessing/multiprocess',
            data: dataJson,
            contentType: 'application/json',
            success: function (Adata) {
                // console.log(Adata); // string
                
                var array = JSON.parse(Adata);
                console.log(array); // object
                delete array.multiresult; // 删除 multiresult：true
                var arr = array.b75c4152_cc303;
                
                var arrSum = JSON.parse(arr);
                // console.log(arrSum);

                var tableContent = '';
                for(var j = 0; j < arrSum.length; j++) {
                    var data = arrSum[j];
                    // console.log(data);
                        
                    tableContent += '<tr style="height: 40px;">'
                        for( var key in data.properties) {
                            var td = '<td>'+ key +'</td>' + '<td class="td">'+ data.properties[key] +'</td>'
                            tableContent += td;
                        }            
                    tableContent += '</tr>';
                } 

                // 分页
                var span ='</div>' + '<ul class="pages">' + '<li class="next">' + '下一页' + '</li>' + '<li class="prev">' + '上一页' + '</li>' + '<li class="total">' + '总页数' + '</li>' + '</div>'    
                    // + '<li class="cur_page">' + '当前页数' + '</li>' 

                var pageParam = {
                    next: '.next', //下一页
                    prev: '.prev', //上一页
                    totalEl: '.total', //总页数jq元素  
                    curPageEl: '.cur_page', //当前页数jq元素 
                    perPageCount: 4, //每页显示数量，
                    totalPage: arrSum.length // 总的td数量
                }
                    // console.log(arrSum.length);        
                tableContent = tableContent + span; 
                document.getElementById('table').innerHTML = tableContent;
                //包裹列表的容器
                $('#table tbody').page(pageParam);

                
                // var map, url = "http://localhost:8090/iserver/services/map-temp-799822660/rest/maps/temp-799822660";
                    

                for (let n in array) {
                    // console.log(array[n]);
                    if(n == "63f307ac-afed-4720-bbfd-423ac68a0ff9")
                    {
                        var path = JSON.parse(array[n]);
                    console.log(path);
                    var end = path[path.length-1]
                    console.log(end);

                    var map,url = end.serviceAddress + "/maps/temp-799822660";
                    console.log(end.serviceAddress);
                    console.log(url);

                    var extent = [38484026.53, 4411156.34, 38497031.32, 4422701.44 ];
                    var projection = new ol.proj.Projection({
                        code:'',
                        extent: extent,
                        units: 'm',
                        getPointResolution:function(resolution, point){
                            return resolution
                        }
                    });

                    new ol.supermap.MapService(url).getMapInfo(function (serviceResult) {
                        var mapJSONObj = serviceResult.result;
                        console.log(mapJSONObj);
                        x = mapJSONObj.center.x;
                        y = mapJSONObj.center.y;
                        epsgCode = mapJSONObj.prjCoordSys.epsgCode
                        console.log(x,y,epsgCode);
    
                        var map = new ol.Map({
                            target: 'map',
                            controls: ol.control.defaults({attributionOptions: {collapsed: false}})
                                .extend([new ol.supermap.control.Logo()]),
                            view: new ol.View({
                                center: [38490528.93 , 4416928.89],
                                zoom: 1,
                                projection: projection,
                                origin: [48.4, -55.58],
                                multiWorld: true
                            })
                        });
                        var layer = new ol.layer.Tile({
                            source: new ol.source.TileSuperMapRest(ol.source.TileSuperMapRest.optionsFromMapJSON(url, mapJSONObj))
                        });
                        map.addLayer(layer);
                        map.addControl(new ol.supermap.control.ScaleLine());
                    });

                    } 
                }    
            },
            error: function (jqXHR) {
                console.log(jqXHR);
            }
        });
    }   
   
</script>


<script type="text/javascript" src="js/bootstrap.min.js"></script>
</body>
</html>